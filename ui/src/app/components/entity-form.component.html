<div class="container-fluid mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>{{ mode }} {{ entityType | titlecase }}</h2>
    <div class="form-button-group">
      <!-- Details mode: Show Back button -->
      <button *ngIf="isDetailsMode()" class="btn btn-form-back" (click)="goBack()">
        <i class="fas fa-arrow-left"></i>
        Back
      </button>

      <!-- Edit/Create mode: Show Submit and Cancel buttons -->
      <ng-container *ngIf="!isDetailsMode()">
        <button type="submit" class="btn btn-form-submit me-2" [disabled]="entityForm && entityForm.invalid || submitting" form="entityForm">
          <i class="fas" [ngClass]="submitting ? 'fa-spinner fa-spin' : 'fa-check'"></i>
          {{ submitting ? 'Saving...' : 'Submit' }}
        </button>
        <button type="button" class="btn btn-form-cancel" (click)="goBack()">
          <i class="fas fa-times"></i>
          Cancel
        </button>
      </ng-container>
    </div>
  </div>

  <!-- Operation Result Banner -->
  <operation-result-banner
    [message]="operationMessage"
    [type]="operationType"
    (dismissed)="onBannerDismissed()">
  </operation-result-banner>

  <div *ngIf="entityForm">
    <form id="entityForm" [formGroup]="entityForm" (ngSubmit)="onSubmit()">
      <div class="card">
        <div class="card-body">
          <div class="row">
            <ng-container *ngFor="let fieldName of sortedFields">
              <div class="col-md-6 mb-3">
                <div class="row align-items-center">
                  <!-- Labels are consistent for all fields -->
                  <div class="col-4">
                    <label [for]="fieldName" class="form-label">
                      {{ getFieldDisplayName(fieldName) }}
                      <span *ngIf="isFieldRequired(fieldName)" class="text-danger">*</span>
                    </label>
                  </div>

                  <div class="col-8">
                    <!-- Unified field rendering with ngSwitch -->
                    <ng-container [ngSwitch]="formGenerator.getFieldAttributes(entityType, fieldName, mode).fieldType">

                      <!-- Phase 4: Checkbox -->
                      <ng-container *ngSwitchCase="'checkbox'">
                        <div class="checkbox-wrapper">
                          <input type="checkbox"
                            [id]="fieldName"
                            [formControlName]="fieldName"
                            [disabled]="isDetailsMode()"
                            class="form-check-input"
                            [class.details-mode-checkbox]="isDetailsMode()">
                        </div>
                      </ng-container>

                      <!-- Phase 2: Textarea -->
                      <ng-container *ngSwitchCase="'textarea'">
                        <textarea
                          [id]="fieldName"
                          [formControlName]="fieldName"
                          [attr.readonly]="isDetailsMode() ? '' : null"
                          class="form-control"
                          [class.is-invalid]="isFieldInvalid(fieldName) || getFieldValidationError(fieldName) !== null"
                          rows="3">
                        </textarea>
                      </ng-container>

                      <!-- Phase 2: JSON input -->
                      <ng-container *ngSwitchCase="'json'">
                        <textarea
                          [id]="fieldName"
                          [formControlName]="fieldName"
                          [attr.readonly]="isDetailsMode() ? '' : null"
                          class="form-control"
                          [class.is-invalid]="isFieldInvalid(fieldName) || getFieldValidationError(fieldName) !== null"
                          rows="3"
                          placeholder="{ }">
                        </textarea>
                      </ng-container>

                      <!-- Phase 2: Array input -->
                      <ng-container *ngSwitchCase="'array'">
                        <textarea
                          [id]="fieldName"
                          [formControlName]="fieldName"
                          [attr.readonly]="isDetailsMode() ? '' : null"
                          class="form-control"
                          [class.is-invalid]="isFieldInvalid(fieldName) || getFieldValidationError(fieldName) !== null"
                          rows="3"
                          placeholder="[]">
                        </textarea>
                      </ng-container>

                      <!-- Phase 3: Number input -->
                      <ng-container *ngSwitchCase="'number'">
                        <input
                          type="number"
                          [id]="fieldName"
                          [formControlName]="fieldName"
                          [attr.readonly]="isDetailsMode() ? '' : null"
                          [class.show-spinner]="shouldShowSpinner(fieldName) && !isDetailsMode()"
                          [step]="getSpinnerStep(fieldName)"
                          class="form-control"
                          [class.is-invalid]="isFieldInvalid(fieldName) || getFieldValidationError(fieldName) !== null">
                      </ng-container>

                      <!-- Phase 3: Date input -->
                      <ng-container *ngSwitchCase="'date'">
                        <input
                          type="date"
                          [id]="fieldName"
                          [formControlName]="fieldName"
                          [attr.readonly]="isDetailsMode() ? '' : null"
                          class="form-control"
                          [class.is-invalid]="isFieldInvalid(fieldName) || getFieldValidationError(fieldName) !== null">
                      </ng-container>

                      <!-- Phase 5: Select dropdown (enums) -->
                      <ng-container *ngSwitchCase="'select'">
                        <!-- Details mode: show value as readonly text -->
                        <input
                          *ngIf="isDetailsMode()"
                          type="text"
                          [id]="fieldName"
                          [formControlName]="fieldName"
                          [attr.readonly]="''"
                          class="form-control">

                        <!-- Edit/Create mode: show dropdown -->
                        <select
                          *ngIf="!isDetailsMode()"
                          [id]="fieldName"
                          [formControlName]="fieldName"
                          class="form-select"
                          [class.is-invalid]="isFieldInvalid(fieldName) || getFieldValidationError(fieldName) !== null">
                          <option value="">{{ isFieldRequired(fieldName) ? 'Select ' + getFieldDisplayName(fieldName) + '...' : '' }}</option>
                          <option *ngFor="let option of getFieldOptions(fieldName)" [value]="option">
                            {{ option }}
                          </option>
                        </select>
                      </ng-container>

                      <!-- Phase 6: ObjectId (FK) fields -->
                      <ng-container *ngSwitchCase="'ObjectId'">
                        <!-- Details mode: show as readonly input with gray background -->
                        <div *ngIf="isDetailsMode()">
                          <!-- Clickable link for valid FK -->
                          <input
                            *ngIf="!hasFieldValidationError(fieldName)"
                            type="text"
                            [id]="fieldName"
                            [value]="entity[fieldName]"
                            readonly
                            class="form-control"
                            style="cursor: pointer; color: blue; text-decoration: underline;"
                            (click)="openLink(fieldName)">

                          <!-- Plain text for invalid FK -->
                          <input
                            *ngIf="hasFieldValidationError(fieldName)"
                            type="text"
                            [id]="fieldName"
                            [value]="entity[fieldName]"
                            readonly
                            class="form-control">
                        </div>

                        <!-- Edit/Create mode: text input + Select button -->
                        <div *ngIf="!isDetailsMode()" class="input-group">
                          <input
                            type="text"
                            [id]="fieldName"
                            [formControlName]="fieldName"
                            class="form-control"
                            [class.is-invalid]="isFieldInvalid(fieldName) || getFieldValidationError(fieldName) !== null"
                            placeholder="Enter ID or click Select">

                          <button
                            class="btn btn-outline-secondary"
                            type="button"
                            (click)="openLink(fieldName)">
                            Select
                          </button>
                        </div>
                      </ng-container>

                      <!-- Phase 1: Default text inputs (text, email, password, etc.) -->
                      <ng-container *ngSwitchDefault>
                        <input
                          [type]="formGenerator.getFieldAttributes(entityType, fieldName, mode).fieldType"
                          [id]="fieldName"
                          [formControlName]="fieldName"
                          [attr.readonly]="isDetailsMode() ? '' : null"
                          class="form-control"
                          [class.is-invalid]="isFieldInvalid(fieldName) || getFieldValidationError(fieldName) !== null">
                      </ng-container>

                      <!-- More field types will be added in subsequent phases -->

                    </ng-container>

                    <!-- P5: UNIFIED validation error display -->
                    <div *ngIf="hasFieldValidationError(fieldName)" class="text-danger mt-1 small">
                      {{ getFieldValidationError(fieldName) }}
                    </div>
                  </div>
                </div>
              </div>
            </ng-container>

          </div>
        </div>

        <div *ngIf="isDetailsMode()" class="card-footer">
          <div class="details-action-buttons">
            <!-- Consistent button order: Create | Edit | Delete -->
            <button *ngIf="entityService.canCreate(entityType)" type="button" class="btn btn-details-create" (click)="entityService.navigateToCreate(entityType)">
              <i class="fas fa-plus"></i>
              Create
            </button>
            <button *ngIf="entityService.canUpdate(entityType)" type="button" class="btn btn-details-edit" (click)="goToEdit()">
              <i class="fas fa-edit"></i>
              Edit
            </button>
            <button *ngIf="entityService.canDelete(entityType)" type="button" class="btn btn-details-delete" (click)="deleteEntity()">
              <i class="fas fa-trash"></i>
              Delete
            </button>
          </div>
        </div>
      </div>
    </form>
  </div>
  
  <!-- Entity Selector Modal -->
  <app-entity-selector-modal
    [visible]="showEntitySelector"
    [entityType]="entitySelectorType"
    [entities]="entitySelectorEntities"
    [displayColumns]="entitySelectorColumns"
    (close)="onEntitySelectorClosed()"
    (entitySelected)="onEntitySelected($event)">
  </app-entity-selector-modal>
</div>